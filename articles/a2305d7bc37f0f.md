---
title: "KVM ã‚²ã‚¹ãƒˆãƒžã‚·ãƒ³ç«‹ã¡ä¸Šã’æ™‚ã®å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰ä¸€è¦§"
emoji: "ðŸ’¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ubuntu]
published: true
---


# 0. INTRODUCTION

DataScienceç”¨dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹ãŸã‚ã€KVM ã®ã‚²ã‚¹ãƒˆãƒžã‚·ãƒ³ç«‹ã¡ä¸Šã’æ™‚ã«å®Ÿæ–½ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã¾ã¨ã‚ãŸ
ãƒ›ã‚¹ãƒˆOSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ã€ï¼ˆãƒ›ã‚¹ãƒˆå´ã§ã®ï¼‰KVMã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯å¯¾è±¡å¤–ã¨ã™ã‚‹ã€‚

## 0.1. Environment

- host OS: ubuntu 24.04 LTS Desktop
- VM hypervisor: KVM
- guest OS: ubuntu 24.04 LTS Server

## 0.2. Prerequisite

æœ¬è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®å‰ææ¡ä»¶ã®ã‚‚ã¨è¨˜è¼‰ã‚’é€²ã‚ã‚‹ã€‚èª­è€…ã®ç’°å¢ƒã«ã‚ˆã£ã¦ã¯IPã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå¤‰ã‚ã‚‹ãŸã‚ã€é©å®œèª­ã¿æ›¿ãˆã¦å®Ÿæ–½ã®ã“ã¨

- guest OS ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: bigbrother
- NFS server: 192.168.122.1:/loc0/kousuke/repositories
- Zenn ã®ç·¨é›†ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /loc0/bigbrother/repositories/0015_zenn/


# 1. apt update & upgrade

```bash
sudo apt update
sudo apt upgrade
```

# 2. NFS ã®ãƒžã‚¦ãƒ³ãƒˆ


## 2.1. ãƒžã‚¦ãƒ³ãƒˆå…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ

```bash
sudo mkdir -p /loc0/bigbrother/repositories
sudo chown -R bigbrother:bigbrother /loc0/bigbrother/
ls -ld /loc0/bigbrother/repositories

```

## 2.2. nfsã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å°Žå…¥

```bash
sudo apt install nfs-common
```

## 2.3. ãƒžã‚¦ãƒ³ãƒˆ

```bash
sudo mount -t nfs 192.168.122.1:/loc0/kousuke/repositories /loc0/bigbrother/repositories/
```

# 3. npm, zenn-cli ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

## 3.1. npmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
sudo apt install npm
```

## 3.2. zenn ç·¨é›†ç”¨ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ç§»å‹•ã€ãªã‚‰ã³ã«å¤ã„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤

```bash
cd /loc0/bigbrother/repositories/0015_zenn
rm package-lock.json package.json  
```

## 3.3. zenn-cli ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install  zenn-cli
```

- æ–°è¦è¨˜äº‹ä½œæˆ

```bash
npx zenn new:article
```

# 4. git repository ã® pull

## 4.1. ssh key ã®ä½œæˆ

```bash
cd /home/bigbrother/.ssh/
ssh-keygen -t rsa -C [github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹]
```

pass phrase ã‚’èžã‹ã‚Œã‚‹ãŒã€ä»Šå›žã¯è¨­å®šã›ãšã‹ã‚‰ã®ã¾ã¾ Enter key ã‚’æŠ¼ä¸‹

```bash
$ ssh-keygen -t rsa -C [XXX@yyy.com]

Generating public/private rsa key pair.
Enter file in which to save the key (/home/bigbrother/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/bigbrother/.ssh/id_rsa
Your public key has been saved in /home/bigbrother/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:hogehoge [XXX@yyy.com]
The key's randomart image is:
+---[RSA 3072]----+
|   .....  .....  |
|   .....  .....  |
|   .....  .....  |
|   .....  .....  |
|   .....  .....  |
|   .....  .....  |
|   .....  .....  |
|   .....  .....  |
+----[SHA256]-----+

```

ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã€ä¸¦ã³ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿èª­æ›¸å¯èƒ½ãªçŠ¶æ…‹ã«ã—ã¦ãŠã

```bash
ls -altr
chmod 600 id_rsa.pub 
ls -altr
```

å‡ºåŠ›çµæžœ

```bash
$ ls -altr

total 16
...
-rw-r--r-- 1 bigbrother bigbrother  587 Aug  8 05:34 id_rsa.pub
...

$ chmod 600 id_rsa.pub 

$ ls -altr
total 16
...
-rw------- 1 bigbrother bigbrother  587 Aug  8 05:34 id_rsa.pub
...

```

## 4.2. id_rst.pub ã®å†…å®¹ã® github ssh-key ã¸ã®ç™»éŒ²

id_rsa.pub ã®å†…å®¹ã‚’å‡ºåŠ›ã™ã‚‹

```bash
cat ~/.ssh/id_rsa.pub 
```
rsa ã®å†…å®¹ã®ã†ã¡ã€ã€€"[github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹]" ã«ã¤ã„ã¦ã¯é™¤å¤–ã—ã¦ã€github ssh-key ã«ç™»éŒ²ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç›´å‰ã®ç©ºç™½ã‚‚é™¤å¤–ã—ç™»éŒ²ã™ã‚‹

> ssh-rsa LOIOYOJYTYoMIUHLIUGIFYLJHgJHFKUGFFYKGFLJHGLyG (....) = [github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹]


## 4.3. git config ã®è¨­å®š

ä»¥ä¸‹ã‚’è¨­å®šã™ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®è¨­å®š
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¨­å®š
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã®åç§°è¨­å®š("main" ã«è¨­å®š)

```bash
git config --global [github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å]
git config --global [github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹]
git config --global init.defaultBranch main
cat ~/.gitconfig 
```

å‡ºåŠ›çµæžœ
```bash
$ cat ~/.gitconfig 

[user]
	name = [github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å]
	email = [github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹]
[init]
	defaultBranch = main

```

## 4.4. git ã®é–‹å§‹ã€ä¸¦ã³ã«pull

```bash
cd /loc0/bigbrother/repositories/0015_zenn
git init
git remote add [remote_repository_name] git@github.com:[github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å]/[remote_repository_name].git
git pull [remote_repository_name] main
```

å‡ºåŠ›çµæžœï¼ˆï¼’å›žç›®ã®å®Ÿè¡Œçµæžœãªã®ã§ã€`Already up to date.` ã¨å‡ºã¦ã„ã‚‹ï¼‰

```bash
$ git pull 0015_zenn main

The authenticity of host 'github.com (20.27.177.113)' can't be established.
ED25519 key fingerprint is SHA256:hogehoge
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'github.com' (ED25519) to the list of known hosts.
From github.com:[github ã«ç™»éŒ²ã—ã¦ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å]/[remote_repository_name]
 * branch            main       -> FETCH_HEAD
Already up to date.
```


# 5. docker ã®è¨­å®š

## 5.1. ä½œæ¥­ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ç§»å‹•

```bash
cd ~
mkdir -p docker/0015_zenn
cd docker/0015_zenn
pwd
ls -altr
```

## 5.2.  docker-composed.yaml ã®ä½œæˆ

```bash
vi docker-compose.yaml 
```

ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ä»¥ä¸‹ã®é€šã‚Š

```yaml
services:
  # ã‚µãƒ¼ãƒ“ã‚¹åã‚’'notebook'ã«æŒ‡å®š
  notebook:
    # Dockerfileã‚’æŒ‡å®šï¼ˆdocker-compose.ymlã¨åŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
    build:
      context: .
      dockerfile: Dockerfile
    # ãƒãƒ¼ãƒˆç•ªå·ã‚’æŒ‡å®š
    ports:
      - "10015:8888" ## ãƒãƒ¼ãƒˆç•ªå·ã¯ä»»æ„ã®ã‚‚ã®ã‚’è¨˜è¼‰
    environment:
      - JUPYTER_ENABLE_LAB=yes # Jupyter Labã‚’æœ‰åŠ¹åŒ–
      - TZ=Asia/Tokyo # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æŒ‡å®š
    # ãƒ›ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ†ãƒŠã§ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã™ã‚‹ãŸã‚ã«workãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒžã‚¦ãƒ³ãƒˆ
    volumes:
      - repository:/home/jovyan/work ## NFSãƒžã‚¦ãƒ³ãƒˆã‚’è¡Œã†ãŸã‚ã€Volumesã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½œæˆã™ã‚‹
    # ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã‚’ç„¡åŠ¹åŒ–
    command: start-notebook.sh --NotebookApp.token=''

volumes:
  repository:
    driver_opts:
      type: nfs
      o: "addr=192.168.122.1,soft,nfsvers=4" ## NFS ã®è¨­å®šã€‚ã“ã“ã®éƒ¨åˆ†ã¯NFS Server å´ã®è¨­å®šã¨ä¸€è‡´ã•ã›ã‚‹
      device: ":/loc0/kousuke/repositories/0015_zenn" ## NFS ã®è¨­å®šã€‚ã“ã“ã®éƒ¨åˆ†ã¯NFS Server å´ã®è¨­å®šã¨ä¸€è‡´ã•ã›ã‚‹
```

## 5.3.  Dockerfile ã®ä½œæˆ

```bash
vi Dockerfile
```

ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚latest æŒ‡å®šã«ã‚ˆã‚‹ container image ã®å¤‰æ›´ã‚’é¿ã‘ã‚‹ãŸã‚ã€docker image ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’æŒ‡å®šã—ã¦ã„ã‚‹

```yaml
# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦jupyter/datascience-notebookã®æœ€æ–°ç‰ˆã‚’ä½¿ç”¨

## # latest @ 2024/08/06
## FROM jupyter/datascience-notebook@sha256:476c6e673e7d5d8b5059f8680b1c6a988942a79263da651bf302dc696ab311f2

## # x86_64-ubuntu-22.04 latest @ 2024/08/06
FROM jupyter/datascience-notebook@sha256:98c2b44b4e44e044a8670ac27b201704e5222f8a7d748eb7cfd94a2cdad52e7d

# ä»¥é™ã®RUNã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’rootã«å¤‰æ›´
USER root

# jovyanãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§sudoã‚’è¨±å¯ã™ã‚‹è¨­å®šã‚’/etc/sudoersã«è¿½åŠ 
RUN echo "jovyan ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’jovyanã«æˆ»ã™
USER jovyan
```
## 5.4. docker-compose ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•

current directory ã« docker-compose.yaml ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã©ã†ã‹ç¢ºèªã™ã‚‹

```bash
pwd
ls -altr
```

å‡ºåŠ›çµæžœ
```bash
$ pwd

/home/bigbrother/docker/0015_zenn

$ ls -altr

total 16
drwxrwxr-x 3 bigbrother bigbrother 4096 Aug  8 05:46 ..
-rw-rw-r-- 1 bigbrother bigbrother 1057 Aug  8 05:47 docker-compose.yaml
-rw-rw-r-- 1 bigbrother bigbrother  670 Aug  8 05:47 Dockerfile
drwxrwxr-x 2 bigbrother bigbrother 4096 Aug  8 05:47 .
```

docker-composed ã«ã‚ˆã‚Š container ã‚’èµ·å‹•ã™ã‚‹ï¼ˆåˆå›žã¯ docker image ã‚’ pull ã™ã‚‹ãŸã‚æ™‚é–“ãŒã‹ã‹ã‚‹ï¼‰

```bash
sudo docker-compose up -d
 ```

èµ·å‹•çµæžœã‚’ç¢ºèªã™ã‚‹

```bash
sudo sudo docker-compose ls
sudo docker container ps
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€èµ·å‹•ã—ãŸã‚³ãƒ³ãƒ†ãƒŠãŒè¡¨ç¤ºã•ã‚Œã‚Œã°è‰¯ã„

```bash
$ sudo docker-compose ls
 
NAME                STATUS              CONFIG FILES
0015_zenn           running(1)          /home/bigbrother/docker/0015_zenn/docker-compose.yaml
```

```bash
bigbrother@mandam:~/docker/0015_zenn$ sudo docker ps
CONTAINER ID   IMAGE                COMMAND                  CREATED       STATUS                 PORTS                                         NAMES
620c2adf130c   0015_zenn-notebook   "tini -g -- start-noâ€¦"   3 hours ago   Up 3 hours (healthy)   0.0.0.0:10015->8888/tcp, :::10015->8888/tcp   0015_zenn-notebook-1
```
